name: Split Growfund Pro features

on:
  push:
    branches:
      - split/pro-features
    tags:
      - 'v*'

jobs:
  split-pro-features:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Growfund Pro!
        uses: actions/checkout@v4
        with:
          path: growfund-pro
          fetch-depth: 0
          persist-credentials: false

      - name: Remove pro-only files
        run: |
          cd growfund-pro
          if [ -f .growfundignore ]; then
            cat .growfundignore | xargs rm -rf || true
          fi

      - name: Checkout Growfund Free
        uses: actions/checkout@v4
        with:
          repository: ahamed/growfund
          token: ${{ secrets.GROWFUND_SYNC_TOKEN_PRO }}
          path: growfund-free
          fetch-depth: 0
          persist-credentials: false

      - name: Sync files from pro -> free
        run: |
          rsync -av --delete \
            growfund-pro/ \
            growfund-free/

      - name: Commit and push changes to new branch
        env:
          GH_TOKEN: ${{ secrets.GROWFUND_SYNC_TOKEN_PRO }}
        run: |
          cd growfund-free

          git config user.name "growfund-sync-bot"
          git config user.email "growfund-sync-bot@growfund.com"

          git remote set-url origin "https://oauth2:${GH_TOKEN}@github.com/ahamed/growfund.git"

          BRANCH="target/free-only"

          git checkout -b "$BRANCH"
          git add -A
          git commit -m "Sync from growfund-pro ($GITHUB_SHA)" || echo "No changes to commit"
          git push -f origin "$BRANCH"

      - name: Create pull request
        env:
          GH_TOKEN: ${{ secrets.GROWFUND_SYNC_TOKEN_PRO }}
        run: |
          cd growfund-free
          BRANCH="target/free-only"
          gh pr create \
            --repo ahamed/growfund \
            --head "$BRANCH" \
            --base main \
            --title "Split Growfund Pro features ($GITHUB_SHA)" \
            --body "This pull request is automatically created by the split workflow"
